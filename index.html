<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enlluernand ‚Äî Configurador & Cat√°logo</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- Firebase SDK (modular) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Librer√≠as para PDF (opcional) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #e6f3ff; }
    header {
      background: #0077cc;
      color: white;
      padding: 15px 20px;
      position: relative;
      text-align: left;
    }
    header h1 { margin: 0; font-size: 28px; text-align: center; }
    header p { margin: 5px 0 0; font-size: 16px; text-align: center; }

    .header-buttons {
      display: flex;
      gap: 15px;
      position: absolute;
      top: 15px;
      right: 20px;
    }

    .auth-btn, .cart-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .auth-btn { background: white; color: #0077cc; border: none; }
    .auth-btn:hover { background: #eef; }
    .cart-btn { background: #0077cc; color: white; border: none; }
    .cart-btn:hover { background: #005fa3; }

    .main-container { display: flex; gap: 20px; max-width: 1400px; margin: 20px auto; padding: 0 20px; }
    section { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px; }
    #configurador { flex: 2; }
    #catalogo { flex: 1; }

    h2 { border-bottom: 2px solid #0077cc; padding-bottom: 5px; }
    label { display: block; margin: 8px 0 4px; font-weight: bold; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 6px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #0077cc; color: #fff; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin: 5px 5px 0 0; }
    button:hover { background: #005fa3; }
    .summary { background: #eef7ff; padding: 10px; border-radius: 6px; margin-top: 10px; }

    .color-options { display: flex; gap: 10px; margin: 8px 0 12px; }
    .color-ball { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #333; cursor: pointer; }
    .config-container { display: flex; gap: 20px; }
    .preview { flex: 1; background: #f9f9f9; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-direction: column; font-size: 18px; min-height: 300px; position: relative; }
    .collar-base {
      width: 180px; height: 80px; border-radius: 50%; margin: 20px auto; position: relative;
    }
    .colgante {
      width: 40px; height: 40px; border-radius: 50%; position: absolute; top: 30px; left: 70px;
    }

    .sidebar { position: fixed; top: 0; right: -400px; width: 350px; height: 100%; background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.2); transition: right 0.3s ease; padding: 20px; display: flex; flex-direction: column; z-index: 1000; }
    .sidebar.open { right: 0; }
    .sidebar h2 { margin-top: 0; }
    .cesta-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .close-btn { background: #ccc; color: black; align-self: flex-end; margin-bottom: 10px; }
  </style>
</head>
<body>

  <header>
    <h1>Enlluernand</h1>
    <p>Crea tu accesorio o descubre nuestras creaciones</p>
    <div class="header-buttons">
      <button class="auth-btn" id="authButton">Iniciar sesi√≥n</button>
      <button class="cart-btn" id="openCart">üõí Cesta (0)</button>
    </div>
  </header>

  <!-- Modal de Bienvenida -->
  <div id="welcomeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:12px; max-width:400px; text-align:center;">
      <h2 id="welcomeTitle">üéâ ¬°Hola!</h2>
      <p id="welcomeMessage">Tu c√≥digo de descuento es:</p>
      <div id="discountCode" style="font-size:1.5em; font-weight:bold; color:#0077cc; margin:10px 0;"></div>
      <button onclick="copyCode()" style="background:#0077cc; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Copiar c√≥digo</button>
      <button onclick="useCode()" style="margin-top:10px; background:#0077cc; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Usar c√≥digo</button>
      <button onclick="closeModal()" style="margin-top:10px; background:#ccc; color:black; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Cerrar</button>
    </div>
  </div>

  <div class="main-container">
    <!-- Configurador -->
    <section id="configurador">
      <h2>Configurador de accesorios</h2>
      <div class="config-container">
        <div class="preview" id="preview">
          <div class="collar-base" id="collar-base"></div>
          <div class="colgante" id="colgante"></div>
        </div>
        <div class="controls">
          <label>Producto</label>
          <select id="product">
            <option value="collar">Collar</option>
            <option value="pulsera">Pulsera</option>
            <option value="pendientes">Pendientes</option>
          </select>

          <label>Material</label>
          <select id="material">
            <option value="oro">Cadena de oro</option>
            <option value="plata">Cadena de plata</option>
            <option value="cordon">Cord√≥n de colores</option>
          </select>

          <label>Colores disponibles</label>
          <div class="color-options" id="colorOptions">
            <div class="color-ball" style="background:red" data-color="rojo"></div>
            <div class="color-ball" style="background:blue" data-color="azul"></div>
            <div class="color-ball" style="background:green" data-color="verde"></div>
            <div class="color-ball" style="background:yellow" data-color="amarillo"></div>
            <div class="color-ball" style="background:pink" data-color="rosa"></div>
            <div class="color-ball" style="background:purple" data-color="morado"></div>
          </div>

          <label>Colgante</label>
          <select id="colganteSelect"><option value="">Ninguno</option><option value="corazon">Coraz√≥n</option></select>

          <label>Conector</label>
          <select id="conector"><option value="">Ninguno</option><option value="anilla">Anilla</option></select>

          <label>Extras</label>
          <input type="checkbox" id="extraGift"> Estuche para regalo (+5‚Ç¨)<br>
          <input type="checkbox" id="extraWrap"> Envoltorio para regalo (+3‚Ç¨)<br>
          <input type="checkbox" id="extraUrgent"> Fabricaci√≥n urgente (+10‚Ç¨)

          <label>C√≥digo de descuento</label>
          <input type="text" id="discount" placeholder="Introduce tu c√≥digo">

          <label>Cantidad</label>
          <input type="number" id="quantity" value="1" min="1">

          <div class="summary" id="summary">Precio: ‚Ç¨0</div>

          <button id="addToCart">A√±adir a la cesta</button>
          <button id="payNow">Pagar ahora</button>
        </div>
      </div>
    </section>

    <!-- Cat√°logo -->
    <section id="catalogo">
      <h2>Cat√°logo</h2>
      <h3>Collares</h3>
      <img src="https://via.placeholder.com/200?text=Collar+1">
      <h3>Pendientes</h3>
      <img src="https://via.placeholder.com/200?text=Pendiente+1">
      <h3>Pulseras</h3>
      <img src="https://via.placeholder.com/200?text=Pulsera+1">
    </section>
  </div>

  <!-- Sidebar de la Cesta -->
  <div class="sidebar" id="cartSidebar">
    <button class="close-btn" id="closeCart">Cerrar ‚úñ</button>
    <h2>Tu Cesta</h2>
    <div id="cartItems"></div>
    <div class="summary" id="cartSummary">Total: ‚Ç¨0</div>
    <button id="pay">Pagar</button>
  </div>

  <script>
    // Inicializar EmailJS
    (function(){ emailjs.init("QySTAkWHd-G0OkzSS"); })();

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZbhHY9mEr3bBMVZLGxZE4NkGMLSPTcL4",
      authDomain: "enlluernand-77eb5.firebaseapp.com",
      projectId: "enlluernand-77eb5",
      storageBucket: "enlluernand-77eb5.firebasestorage.app",
      messagingSenderId: "904366283683",
      appId: "1:904366283683:web:816bf521d4b858a4a25816"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Variables
    let cart = [];
    let selectedColor = "";
    let userDiscountCode = null;
    let userDisplayName = null;

    // Elementos del DOM
    const summary = document.getElementById("summary");
    const cartItems = document.getElementById("cartItems");
    const cartSummary = document.getElementById("cartSummary");
    const cartBtn = document.getElementById("openCart");
    const preview = document.getElementById("preview");
    const authButton = document.getElementById("authButton");
    const discountInput = document.getElementById("discount");
    const collarBase = document.getElementById("collar-base");
    const colganteElement = document.getElementById("colgante");

    // Generar c√≥digo de descuento √∫nico
    function generarCodigoDescuento() {
      const prefijos = ["BIENVENIDA", "LUZ", "AMOR", "ESTRELLA"];
      const prefijo = prefijos[Math.floor(Math.random() * prefijos.length)];
      const numero = Math.floor(Math.random() * 20 + 5);
      return prefijo + numero + Math.random().toString(36).substr(2, 4).toUpperCase();
    }

    // Mostrar modal de bienvenida
    function mostrarBienvenida(nombre) {
      const codeElem = document.getElementById("discountCode");
      codeElem.textContent = userDiscountCode;

      const titleElem = document.getElementById("welcomeTitle");
      titleElem.textContent = `üéâ ¬°Hola, ${nombre}!`;

      const messageElem = document.getElementById("welcomeMessage");
      messageElem.textContent = `Tu c√≥digo de descuento es:`; 

      document.getElementById("welcomeModal").style.display = "block";
    }

    // Funciones del modal
    function closeModal() {
      document.getElementById("welcomeModal").style.display = "none";
    }

    function copyCode() {
      const code = document.getElementById("discountCode").textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert("‚úÖ C√≥digo copiado al portapapeles!");
      });
    }

    function useCode() {
      const code = document.getElementById("discountCode").textContent;
      discountInput.value = code;
      alert(`‚úÖ C√≥digo "${code}" aplicado al campo.`);
      closeModal();
    }

    // Escuchar cambios de autenticaci√≥n
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userRef = db.collection("usuarios").doc(user.uid);
        const doc = await userRef.get();

        if (!doc.exists) {
          userDiscountCode = generarCodigoDescuento();
          userDisplayName = user.displayName || user.email.split("@")[0];

          await userRef.set({
            email: user.email,
            nombre: userDisplayName,
            fechaRegistro: new Date(),
            codigoDescuento: userDiscountCode,
            usado: false,
            expira: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24h despu√©s
          });

          mostrarBienvenida(userDisplayName);
        } else {
          const data = doc.data();
          userDiscountCode = data.codigoDescuento;
          userDisplayName = data.nombre;

          if (new Date() > new Date(data.expira)) {
            userDiscountCode = null;
          }
          if (data.usado) {
            userDiscountCode = null;
          }
        }
        authButton.textContent = "Cerrar sesi√≥n";
      } else {
        userDiscountCode = null;
        userDisplayName = null;
        authButton.textContent = "Iniciar sesi√≥n";
      }
      renderSummary();
    });

    // Manejar clic en bot√≥n de autenticaci√≥n
    authButton.addEventListener("click", () => {
      const user = auth.currentUser;
      if (user) {
        auth.signOut().then(() => {
          alert("Sesi√≥n cerrada correctamente.");
        });
      } else {
        const opcion = confirm("¬øQuieres iniciar sesi√≥n con Google?\nAceptar = Google, Cancelar = Correo y contrase√±a");
        if (opcion) {
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider).catch(error => {
            alert("Error al iniciar con Google: " + error.message);
          });
        } else {
          const email = prompt("üìß Introduce tu correo electr√≥nico:");
          if (!email) return;
          const password = prompt("üîë Introduce tu contrase√±a (m√≠nimo 6 caracteres):");
          if (!password || password.length < 6) {
            alert("La contrase√±a debe tener al menos 6 caracteres.");
            return;
          }

          auth.fetchSignInMethodsForEmail(email)
            .then(methods => {
              if (methods.length === 0) {
                return auth.createUserWithEmailAndPassword(email, password);
              } else {
                return auth.signInWithEmailAndPassword(email, password);
              }
            })
            .catch(error => {
              alert("Error: " + error.message);
            });
        }
      }
    });

    // C√°lculo de precio
    function calculatePrice(config) {
      let price = 20;
      if (config.material === "oro") price += 30;
      if (config.material === "plata") price += 15;
      if (config.extras.includes("gift")) price += 5;
      if (config.extras.includes("wrap")) price += 3;
      if (config.extras.includes("urgent")) price += 10;
      price *= config.quantity;

      if (config.discount && config.discount === "DESCUENTO10") {
        price *= 0.95;
      } else if (config.discount && config.discount === userDiscountCode) {
        const user = auth.currentUser;
        if (user) {
          db.collection("usuarios").doc(user.uid).get().then(doc => {
            const data = doc.data();
            if (data.usado) {
              alert("‚ùå Este c√≥digo ya fue usado.");
              return;
            }
            if (new Date() > new Date(data.expira)) {
              alert("‚ùå Este c√≥digo ha expirado.");
              return;
            }
            db.collection("usuarios").doc(user.uid).update({ usado: true });
            alert("‚úÖ ¬°C√≥digo de bienvenida aplicado! 5% de descuento.");
          });
        }
        price *= 0.95;
      }

      return Math.round(price * 100) / 100;
    }

    function getConfig() {
      return {
        product: document.getElementById("product").value,
        material: document.getElementById("material").value,
        color: selectedColor,
        colgante: document.getElementById("colganteSelect").value,
        conector: document.getElementById("conector").value,
        extras: [
          document.getElementById("extraGift").checked ? "gift" : null,
          document.getElementById("extraWrap").checked ? "wrap" : null,
          document.getElementById("extraUrgent").checked ? "urgent" : null
        ].filter(Boolean),
        discount: document.getElementById("discount").value,
        quantity: parseInt(document.getElementById("quantity").value) || 1
      };
    }

    function renderSummary() {
      const config = getConfig();
      const price = calculatePrice(config);
      summary.textContent = `Precio: ‚Ç¨${price}`;
      preview.innerHTML = `<strong>${config.product}</strong><br>Material: ${config.material}`;
    }

    function renderCart() {
      cartItems.innerHTML = "";
      let total = 0;
      cart.forEach((item) => {
        const div = document.createElement("div");
        div.className = "cesta-item";
        div.textContent = `${item.quantity}x ${item.product} (${item.material}, ${item.color}) - ‚Ç¨${item.price}`;
        cartItems.appendChild(div);
        total += item.price;
      });
      cartSummary.textContent = `Total: ‚Ç¨${total}`;
      cartBtn.textContent = `üõí Cesta (${cart.length})`;
    }

    // Visor din√°mico
    function updatePreview() {
      const material = document.getElementById("material").value;
      const colgante = document.getElementById("colganteSelect").value;

      // Cambiar color del collar
      if (material === "oro") {
        collarBase.style.backgroundColor = "#f0e68c";
      } else if (material === "plata") {
        collarBase.style.backgroundColor = "#cccccc";
      } else if (material === "cordon") {
        collarBase.style.backgroundColor = "#8b4513";
      }

      // Cambiar colgante
      if (colgante === "corazon") {
        colganteElement.style.display = "block";
        colganteElement.style.backgroundColor = "#ff69b4";
        colganteElement.style.borderRadius = "50%";
      } else {
        colganteElement.style.display = "none";
      }
    }

    ["material", "colganteSelect"].forEach(id => {
      document.getElementById(id).addEventListener("change", updatePreview);
    });

    // Eventos
    document.getElementById("addToCart").addEventListener("click", () => {
      const config = getConfig();
      const price = calculatePrice(config);
      cart.push({ ...config, price });
      renderCart();
      alert("‚úÖ Producto a√±adido a la cesta");
    });

    document.getElementById("pay").addEventListener("click", () => {
      if (cart.length === 0) {
        alert("Tu cesta est√° vac√≠a");
        return;
      }
      alert("‚úÖ Pago procesado. Gracias por tu compra.");
      cart = [];
      renderCart();
      document.getElementById("cartSidebar").classList.remove("open");
    });

    document.getElementById("payNow").addEventListener("click", () => {
      const config = getConfig();
      config.price = calculatePrice(config);
      alert(`‚úÖ Pago inmediato procesado - Total: ‚Ç¨${config.price}`);
    });

    ["product", "material", "colganteSelect", "conector", "discount", "quantity", "extraGift", "extraWrap", "extraUrgent"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("input", renderSummary);
      el.addEventListener("change", renderSummary);
    });

    document.querySelectorAll(".color-ball").forEach(ball => {
      ball.addEventListener("click", () => {
        selectedColor = ball.dataset.color;
        renderSummary();
      });
    });

    document.getElementById("openCart").addEventListener("click", () => {
      document.getElementById("cartSidebar").classList.add("open");
    });

    document.getElementById("closeCart").addEventListener("click", () => {
      document.getElementById("cartSidebar").classList.remove("open");
    });

    renderSummary();
    updatePreview(); // Inicializar visor
  </script>
</body>
</html>
