<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enlluernand ‚Äî Configurador & Cat√°logo</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #e6f3ff; }
    header {
      background: #0077cc;
      color: white;
      padding: 15px 20px;
      position: relative;
      text-align: left;
    }
    header h1 { margin: 0; font-size: 28px; text-align: center; }
    header p { margin: 5px 0 0; font-size: 16px; text-align: center; }

    .header-buttons {
      display: flex;
      gap: 15px;
      position: absolute;
      top: 15px;
      right: 20px;
    }

    .auth-btn, .cart-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .auth-btn { background: white; color: #0077cc; border: none; }
    .auth-btn:hover { background: #eef; }
    .cart-btn { background: #0077cc; color: white; border: none; }
    .cart-btn:hover { background: #005fa3; }

    /* Bloqueo de acceso hasta completar datos */
    .blocked-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
      padding: 20px;
    }

    .blocked-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      color: #333;
    }

    .blocked-content h2 {
      color: #0077cc;
    }

    .blocked-content label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
      text-align: left;
    }

    .blocked-content input, .blocked-content select, .blocked-content textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .blocked-content button {
      background: #0077cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }

    /* Dise√±o de 3 columnas */
    .main-container {
      display: flex;
      gap: 20px;
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }

    #preview-section, #configurador, #catalogo {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
    }

    h2 {
      border-bottom: 2px solid #0077cc;
      padding-bottom: 5px;
      margin-top: 0;
    }

    label {
      display: block;
      margin: 8px 0 4px;
      font-weight: bold;
    }

    select, input[type="number"], input[type="text"] {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background: #0077cc;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px 5px 0 0;
    }

    button:hover {
      background: #005fa3;
    }

    .summary {
      background: #eef7ff;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }

    .item-list {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      max-height: 150px;
      overflow-y: auto;
    }

    .item-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }

    .item-row button {
      background: #ff6666;
      color: white;
      border: none;
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
    }

    .color-options {
      display: flex;
      gap: 10px;
      margin: 8px 0 12px;
    }

    .color-ball {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid #333;
      cursor: pointer;
    }

    /* Vista previa */
    .preview {
      background: #f9f9f9;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 16px;
      min-height: 400px;
      padding: 15px;
      text-align: center;
      flex: 1;
    }

    .preview-title {
      font-size: 1.4em;
      font-weight: bold;
      color: #0077cc;
      margin: 0 0 10px;
    }

    .preview-line {
      font-size: 0.95em;
      color: #555;
      margin: 3px 0;
    }

    .preview-colors {
      display: flex;
      gap: 6px;
      margin: 8px 0;
      justify-content: center;
    }

    /* Cat√°logo */
    #catalogo h3 {
      margin: 15px 0 5px;
      font-size: 16px;
    }

    #catalogo img {
      width: 100%;
      max-width: 200px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 350px;
      height: 100%;
      background: #fff;
      box-shadow: -2px 0 8px rgba(0,0,0,0.2);
      transition: right 0.3s ease;
      padding: 20px;
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }

    .sidebar.open {
      right: 0;
    }

    .cesta-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .close-btn {
      background: #ccc;
      color: black;
      align-self: flex-end;
      margin-bottom: 10px;
    }

    /* Modal de Bizum */
    .modal-bizum {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .modal-content h2 {
      color: #0077cc;
    }

    .modal-content p {
      font-size: 1.1em;
      margin: 10px 0;
    }

    .modal-content .bizum-number {
      font-size: 1.4em;
      font-weight: bold;
      color: #0077cc;
      margin: 10px 0;
    }

    .modal-content button {
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <header>
    <h1>Enlluernand</h1>
    <p>Crea tu accesorio o descubre nuestras creaciones</p>
    <div class="header-buttons">
      <button class="auth-btn" id="authButton">Iniciar sesi√≥n</button>
      <button class="cart-btn" id="openCart">üõí Cesta (0)</button>
    </div>
  </header>

  <!-- Modal de Bienvenida -->
  <div id="welcomeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:12px; max-width:400px; text-align:center;">
      <h2 id="welcomeTitle">üéâ ¬°Hola!</h2>
      <p id="welcomeMessage">Tu c√≥digo de descuento es:</p>
      <div id="discountCode" style="font-size:1.5em; font-weight:bold; color:#0077cc; margin:10px 0;"></div>
      <button onclick="copyCode()" style="background:#0077cc; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Copiar c√≥digo</button>
      <button onclick="useCode()" style="margin-top:10px; background:#0077cc; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Usar c√≥digo</button>
      <button onclick="closeModal()" style="margin-top:10px; background:#ccc; color:black; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Cerrar</button>
    </div>
  </div>

  <!-- Overlay: Datos obligatorios tras registro -->
  <div class="blocked-overlay" id="dataOverlay">
    <div class="blocked-content">
      <h2>üì¶ Completa tus datos de env√≠o</h2>
      <p>Para continuar, por favor completa tu informaci√≥n de contacto y env√≠o.</p>

      <label>Nombre completo *</label>
      <input type="text" id="userDataName">

      <label>Tel√©fono *</label>
      <input type="text" id="userDataPhone">

      <label>Direcci√≥n completa *</label>
      <input type="text" id="userDataAddress">

      <label>C√≥digo postal *</label>
      <input type="text" id="userDataPostal">

      <label>Poblaci√≥n *</label>
      <input type="text" id="userDataCity">

      <label>Provincia *</label>
      <input type="text" id="userDataProvince">

      <label>Pa√≠s *</label>
      <select id="userDataCountry">
        <option value="Andorra">Andorra</option>
        <option value="Espa√±a">Espa√±a</option>
        <option value="Francia">Francia</option>
      </select>

      <button id="saveUserData">Guardar y continuar</button>
    </div>
  </div>

  <!-- Modal de Bizum -->
  <div class="modal-bizum" id="bizumModal">
    <div class="modal-content">
      <h2>üí≥ Pago por Bizum</h2>
      <p><strong id="customMessage">Nombre, haz el pago a trav√©s de Bizum al 676 99 6</strong></p>
      <p><strong id="totalAmount">Total: ‚Ç¨0</strong></p>
      <button id="confirmPayment">He realizado el pago</button>
    </div>
  </div>

  <!-- Contenedor principal: 3 columnas -->
  <div class="main-container">
    
    <!-- 1/3: Vista previa -->
    <section id="preview-section">
      <h2>Vista Previa</h2>
      <div class="preview" id="preview">
        <div class="preview-title">Ning√∫n producto</div>
        <div class="preview-line">Selecciona collar, pulsera o pendientes</div>
      </div>
    </section>

    <!-- 2/3: Configurador -->
    <section id="configurador">
      <h2>Configurador de accesorios</h2>
      <div class="controls">
        <!-- Producto (√∫nico) -->
        <label>Producto</label>
        <select id="product">
          <option value="">Selecciona un producto...</option>
          <option value="collar">Collar</option>
          <option value="pulsera">Pulsera</option>
          <option value="pendientes">Pendientes</option>
        </select>

        <!-- M√∫ltiples materiales -->
        <div>
          <label>Material</label>
          <select id="add-material-select">
            <option value="">Seleccionar material...</option>
            <option value="oro">Cadena de oro</option>
            <option value="plata">Cadena de plata</option>
            <option value="cordon">Cord√≥n de colores</option>
          </select>
          <button type="button" id="add-material-btn">+ A√±adir material</button>
          <div class="item-list" id="materials-list">
            <div class="item-row" id="material-template" style="display:none;">
              <span class="name"></span>
              <button class="remove">‚úñ</button>
            </div>
          </div>
        </div>

        <!-- M√∫ltiples colores -->
        <div>
          <label>Color</label>
          <div class="color-options" id="color-options-add">
            <div class="color-ball" style="background:red" data-color="rojo"></div>
            <div class="color-ball" style="background:blue" data-color="azul"></div>
            <div class="color-ball" style="background:green" data-color="verde"></div>
            <div class="color-ball" style="background:yellow" data-color="amarillo"></div>
            <div class="color-ball" style="background:pink" data-color="rosa"></div>
            <div class="color-ball" style="background:purple" data-color="morado"></div>
          </div>
          <div class="item-list" id="colors-list">
            <div class="item-row" id="color-template" style="display:none;">
              <span class="name"></span>
              <button class="remove">‚úñ</button>
            </div>
          </div>
        </div>

        <!-- Conectores m√∫ltiples -->
        <div>
          <label>Conectores adicionales</label>
          <div class="item-list" id="conectores-list">
            <div class="item-row" id="conector-template" style="display:none;">
              <span class="name"></span>
              <input type="number" value="1" min="1" class="cantidad" style="width:50px;">
              <button class="remove">‚úñ</button>
            </div>
          </div>
          <select id="add-conector-select">
            <option value="">Seleccionar conector...</option>
          </select>
          <button type="button" id="add-conector-btn">+ A√±adir conector</button>
        </div>

        <!-- M√∫ltiples colgantes -->
        <div>
          <label>Colgante</label>
          <select id="add-colgante-select">
            <option value="">Seleccionar colgante...</option>
            <option value="corazon">Coraz√≥n</option>
            <option value="estrella">Estrella</option>
            <option value="nube">Nube</option>
            <option value="flor">Flor</option>
          </select>
          <button type="button" id="add-colgante-btn">+ A√±adir colgante</button>
          <div class="item-list" id="colgantes-list">
            <div class="item-row" id="colgante-template" style="display:none;">
              <span class="name"></span>
              <button class="remove">‚úñ</button>
            </div>
          </div>
        </div>

        <!-- Extras m√∫ltiples -->
        <div>
          <label>Extras</label>
          <div class="item-list" id="extras-list">
            <div class="item-row" id="extra-template" style="display:none;">
              <span class="name"></span>
              <input type="number" value="1" min="1" class="cantidad" style="width:50px;">
              <button class="remove">‚úñ</button>
            </div>
          </div>
          <select id="add-extra-select">
            <option value="">Seleccionar extra...</option>
            <option value="gift">Estuche para regalo</option>
            <option value="wrap">Envoltorio para regalo</option>
            <option value="urgent">Fabricaci√≥n urgente</option>
          </select>
          <button type="button" id="add-extra-btn">+ A√±adir extra</button>
        </div>

        <label>C√≥digo de descuento</label>
        <input type="text" id="discount" placeholder="Introduce tu c√≥digo">

        <label>Cantidad</label>
        <input type="number" id="quantity" value="1" min="1">

        <div class="summary" id="summary">Precio: ‚Ç¨0</div>

        <button id="addToCart">A√±adir a la cesta</button>
        <button id="payNow">Pagar ahora</button>
      </div>
    </section>

    <!-- 3/3: Cat√°logo -->
    <section id="catalogo">
      <h2>Cat√°logo</h2>
      <h3>Collares</h3>
      <img src="https://via.placeholder.com/200?text=Collar+1">
      <h3>Pendientes</h3>
      <img src="https://via.placeholder.com/200?text=Pendiente+1">
      <h3>Pulseras</h3>
      <img src="https://via.placeholder.com/200?text=Pulsera+1">
    </section>

  </div>

  <!-- Sidebar de la Cesta -->
  <div class="sidebar" id="cartSidebar">
    <button class="close-btn" id="closeCart">Cerrar ‚úñ</button>
    <h2>Tu Cesta</h2>
    <div id="cartItems"></div>
    <div class="summary" id="cartSummary">Total: ‚Ç¨0</div>
    <button id="proceedToPayment">Proceder al pago</button>
  </div>

  <script>
    // Inicializar EmailJS
    (function(){ emailjs.init("QySTAkWHd-G0OkzSS"); })();

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZbhHY9mEr3bBMVZLGxZE4NkGMLSPTcL4",
      authDomain: "enlluernand-77eb5.firebaseapp.com",
      projectId: "enlluernand-77eb5",
      storageBucket: "enlluernand-77eb5.firebasestorage.app",
      messagingSenderId: "904366283683",
      appId: "1:904366283683:web:816bf521d4b858a4a25816"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Datos del cliente
    let userData = null;
    let userDisplayName = null;

    // Elementos del DOM
    const dataOverlay = document.getElementById("dataOverlay");
    const userDataName = document.getElementById("userDataName");
    const userDataPhone = document.getElementById("userDataPhone");
    const userDataAddress = document.getElementById("userDataAddress");
    const userDataPostal = document.getElementById("userDataPostal");
    const userDataCity = document.getElementById("userDataCity");
    const userDataProvince = document.getElementById("userDataProvince");
    const userDataCountry = document.getElementById("userDataCountry");
    const saveUserData = document.getElementById("saveUserData");

    const authButton = document.getElementById("authButton");
    const preview = document.getElementById("preview");
    const summary = document.getElementById("summary");
    const cartItems = document.getElementById("cartItems");
    const cartSummary = document.getElementById("cartSummary");
    const cartBtn = document.getElementById("openCart");

    const bizumModal = document.getElementById("bizumModal");
    const customMessage = document.getElementById("customMessage");
    const totalAmount = document.getElementById("totalAmount");
    const confirmPayment = document.getElementById("confirmPayment");

    // Datos de conectores
    const materiales = [
      {"Codigo": 13, "Descripcion": "Conector Collar ORO", "Precio": "2,9200"},
      {"Codigo": 14, "Descripcion": "Conector Collar PLATA", "Precio": "2,6000"},
      {"Codigo": 15, "Descripcion": "Conector Resina ORO", "Precio": "1,3900"},
      {"Codigo": 16, "Descripcion": "Conector Resina PLATA", "Precio": "1,3900"},
      {"Codigo": 114, "Descripcion": "Conector Doble Oro *15cm", "Precio": "2,0300"}
    ];

    // Extras
    const extras = {
      gift: { name: "Estuche para regalo", price: 5 },
      wrap: { name: "Envoltorio para regalo", price: 3 },
      urgent: { name: "Fabricaci√≥n urgente", price: 10 }
    };

    // Variables
    let cart = [];
    let selectedColors = [];

    // Llenar conectores
    function llenarConectores() {
      const select = document.getElementById("add-conector-select");
      select.innerHTML = '<option value="">Seleccionar conector...</option>';
      materiales.forEach(item => {
        const option = document.createElement("option");
        option.value = item.Codigo;
        option.textContent = item.Descripcion;
        select.appendChild(option);
      });
    }

    // Mostrar overlay si falta informaci√≥n
    function checkUserData(user) {
      if (!user) return;
      db.collection("usuarios").doc(user.uid).get().then(doc => {
        if (doc.exists && doc.data().direccion) {
          userData = doc.data().direccion;
        } else {
          dataOverlay.style.display = "flex";
        }
      });
    }

    // Guardar datos del cliente
    saveUserData.addEventListener("click", () => {
      const name = userDataName.value.trim();
      const phone = userDataPhone.value.trim();
      const address = userDataAddress.value.trim();
      const postal = userDataPostal.value.trim();
      const city = userDataCity.value.trim();
      const province = userDataProvince.value.trim();
      const country = userDataCountry.value.trim();

      if (!name || !phone || !address || !postal || !city || !province || !country) {
        alert("‚ö†Ô∏è Completa todos los campos.");
        return;
      }

      userData = { name, phone, address, postal, city, province, country };
      dataOverlay.style.display = "none";

      if (auth.currentUser) {
        db.collection("usuarios").doc(auth.currentUser.uid).set({
          direccion: userData,
          nombre: name,
          telefono: phone,
          email: auth.currentUser.email,
          fecha: new Date()
        }, { merge: true });
      }
    });

    // Escuchar autenticaci√≥n
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userDisplayName = user.displayName || user.email.split("@")[0];
        authButton.textContent = "Cerrar sesi√≥n";
        checkUserData(user);
      } else {
        userData = null;
        userDisplayName = null;
        authButton.textContent = "Iniciar sesi√≥n";
      }
      renderSummary();
    });

    // Manejar autenticaci√≥n
    authButton.addEventListener("click", () => {
      const user = auth.currentUser;
      if (user) {
        auth.signOut();
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => alert("Error: " + err.message));
      }
    });

    // A√±adir funciones del configurador (materiales, colores, conectores, etc.)
    // (C√≥digo funcional completo aqu√≠, igual que en versiones anteriores)

    // [Incluimos aqu√≠ todas las funciones: add-material-btn, add-colgante-btn, etc.]

    document.getElementById("add-material-btn").addEventListener("click", () => {
      const select = document.getElementById("add-material-select");
      const value = select.value;
      if (!value) return;
      const name = select.options[select.selectedIndex].text;
      const list = document.getElementById("materials-list");
      const row = document.createElement("div");
      row.className = "item-row";
      row.dataset.value = value;
      row.innerHTML = `<span class="name">${name}</span><button class="remove">‚úñ</button>`;
      list.appendChild(row);
      select.value = "";
      renderSummary();
    });

    document.getElementById("add-colgante-btn").addEventListener("click", () => {
      const select = document.getElementById("add-colgante-select");
      const value = select.value;
      if (!value) return;
      const name = select.options[select.selectedIndex].text;
      const list = document.getElementById("colgantes-list");
      const row = document.createElement("div");
      row.className = "item-row";
      row.dataset.value = value;
      row.innerHTML = `<span class="name">${name}</span><button class="remove">‚úñ</button>`;
      list.appendChild(row);
      select.value = "";
      renderSummary();
    });

    document.getElementById("color-options-add").addEventListener("click", (e) => {
      if (e.target.classList.contains("color-ball")) {
        const color = e.target.dataset.color;
        if (!selectedColors.includes(color)) {
          selectedColors.push(color);
          const list = document.getElementById("colors-list");
          const row = document.createElement("div");
          row.className = "item-row";
          row.dataset.color = color;
          row.innerHTML = `<span class="name">Color: ${color}</span><button class="remove">‚úñ</button>`;
          list.appendChild(row);
          renderSummary();
        }
      }
    });

    document.getElementById("add-conector-btn").addEventListener("click", () => {
      const select = document.getElementById("add-conector-select");
      const codigo = select.value;
      if (!codigo) return;
      const material = materiales.find(m => m.Codigo == codigo);
      if (!material) return;
      const list = document.getElementById("conectores-list");
      const row = document.createElement("div");
      row.className = "item-row";
      row.dataset.codigo = codigo;
      row.innerHTML = `<span class="name">${material.Descripcion}</span><input type="number" value="1" min="1" class="cantidad" style="width:50px;"><button class="remove">‚úñ</button>`;
      list.appendChild(row);
      select.value = "";
      renderSummary();
    });

    document.getElementById("add-extra-btn").addEventListener("click", () => {
      const select = document.getElementById("add-extra-select");
      const key = select.value;
      if (!key) return;
      const extra = extras[key];
      if (!extra) return;
      const list = document.getElementById("extras-list");
      const row = document.createElement("div");
      row.className = "item-row";
      row.dataset.key = key;
      row.innerHTML = `<span class="name">${extra.name}</span><input type="number" value="1" min="1" class="cantidad" style="width:50px;"><button class="remove">‚úñ</button>`;
      list.appendChild(row);
      select.value = "";
      renderSummary();
    });

    // Eliminar elementos
    document.getElementById("materials-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) e.target.closest(".item-row").remove(); renderSummary();
    });
    document.getElementById("colors-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) {
        const color = e.target.closest(".item-row").dataset.color;
        selectedColors = selectedColors.filter(c => c !== color);
        e.target.closest(".item-row").remove();
        renderSummary();
      }
    });
    document.getElementById("colgantes-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) e.target.closest(".item-row").remove(); renderSummary();
    });
    document.getElementById("conectores-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) e.target.closest(".item-row").remove(); renderSummary();
    });
    document.getElementById("extras-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) e.target.closest(".item-row").remove(); renderSummary();
    });

    // C√°lculo de precio
    function calculatePrice(config) {
      let price = 20;
      const materials = Array.from(document.querySelectorAll("#materials-list .item-row")).map(r => r.dataset.value);
      price += materials.filter(m => m === "oro").length * 30;
      price += materials.filter(m => m === "plata").length * 15;
      price += materials.filter(m => m === "cordon").length * 10;

      const conectores = Array.from(document.querySelectorAll("#conectores-list .item-row")).map(row => {
        const codigo = row.dataset.codigo;
        const cantidad = parseInt(row.querySelector(".cantidad").value) || 1;
        return { codigo, cantidad };
      });
      conectores.forEach(item => {
        const material = materiales.find(m => m.Codigo == item.codigo);
        if (material) {
          const precioNum = parseFloat(material.Precio.replace(",", "."));
          price += precioNum * item.cantidad;
        }
      });

      const extrasList = Array.from(document.querySelectorAll("#extras-list .item-row")).map(row => {
        const key = row.dataset.key;
        const cantidad = parseInt(row.querySelector(".cantidad").value) || 1;
        return { key, cantidad };
      });
      extrasList.forEach(item => {
        const extra = extras[item.key];
        if (extra) {
          price += extra.price * item.cantidad;
        }
      });

      price *= config.quantity;
      return Math.round(price * 100) / 100;
    }

    function getConfig() {
      return {
        product: document.getElementById("product").value,
        materials: Array.from(document.querySelectorAll("#materials-list .item-row")).map(r => r.dataset.value),
        colors: selectedColors,
        colgantes: Array.from(document.querySelectorAll("#colgantes-list .item-row")).map(r => r.dataset.value),
        conectores: Array.from(document.querySelectorAll("#conectores-list .item-row")).map(row => ({
          codigo: row.dataset.codigo,
          cantidad: parseInt(row.querySelector(".cantidad").value) || 1
        })),
        extras: Array.from(document.querySelectorAll("#extras-list .item-row")).map(row => ({
          key: row.dataset.key,
          cantidad: parseInt(row.querySelector(".cantidad").value) || 1
        })),
        discount: document.getElementById("discount").value,
        quantity: parseInt(document.getElementById("quantity").value) || 1
      };
    }

    function renderSummary() {
      const config = getConfig();
      const price = calculatePrice(config);
      summary.textContent = `Precio: ‚Ç¨${price}`;

      const product = config.product;
      if (!product) {
        preview.innerHTML = `
          <div class="preview-title">Ning√∫n producto</div>
          <div class="preview-line">Selecciona collar, pulsera o pendientes</div>
        `;
        return;
      }

      let html = `<div class="preview-title">${product.charAt(0).toUpperCase() + product.slice(1)}</div>`;
      const materials = config.materials;
      if (materials.length > 0) html += `<div class="preview-line">Materiales: ${materials.join(", ")}</div>`;
      if (config.colors.length > 0) {
        html += `<div class="preview-line">Colores:</div><div class="preview-colors">`;
        config.colors.forEach(color => {
          html += `<div class="color-ball" style="background:${color}; width:18px; height:18px;"></div>`;
        });
        html += `</div>`;
      }
      preview.innerHTML = html;
    }

    function renderCart() {
      cartItems.innerHTML = "";
      let total = 0;
      cart.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "cesta-item";
        div.innerHTML = `
          <strong>${item.quantity}x ${item.product}</strong><br>
          Materiales: ${item.materials.join(", ")}<br>
          Colores: ${item.colors.join(", ")}<br>
          Precio: ‚Ç¨${item.price}
          <hr>
        `;
        cartItems.appendChild(div);
        total += item.price;
      });
      cartSummary.textContent = `Total: ‚Ç¨${total}`;
      cartBtn.textContent = `üõí Cesta (${cart.length})`;
    }

    document.getElementById("addToCart").addEventListener("click", () => {
      const config = getConfig();
      const product = config.product;
      if (!product) {
        alert("‚ö†Ô∏è Por favor, selecciona un producto");
        return;
      }
      const price = calculatePrice(config);
      cart.push({ ...config, price });
      renderCart();
      alert("‚úÖ Art√≠culo a√±adido a la cesta");
    });

    // Mostrar modal de Bizum
    function showBizumModal(order) {
      customMessage.textContent = `${userData.name}, haz el pago a trav√©s de Bizum al 676 99 6`;
      totalAmount.textContent = `Total: ‚Ç¨${order.total}`;
      bizumModal.style.display = "flex";

      confirmPayment.onclick = null;
      confirmPayment.onclick = () => {
        sendConfirmationEmails(order, userData);
        if (order.type === "cesta") {
          cart = [];
          renderCart();
          document.getElementById("cartSidebar").classList.remove("open");
        }
        bizumModal.style.display = "none";
        alert(`‚úÖ Gracias por tu compra, ${userData.name}!\nPronto recibir√°s la factura por email.`);
      };
    }

    document.getElementById("payNow").addEventListener("click", () => {
      const config = getConfig();
      const product = config.product;
      if (!product) {
        alert("‚ö†Ô∏è Selecciona un producto antes de pagar");
        return;
      }
      if (!userData) {
        alert("‚ö†Ô∏è Completa tus datos de env√≠o primero");
        dataOverlay.style.display = "flex";
        return;
      }
      const price = calculatePrice(config);
      const order = { items: [ { ...config, price } ], total: price, type: "individual" };
      showBizumModal(order);
    });

    document.getElementById("proceedToPayment").addEventListener("click", () => {
      if (cart.length === 0) {
        alert("Tu cesta est√° vac√≠a");
        return;
      }
      if (!userData) {
        alert("‚ö†Ô∏è Completa tus datos de env√≠o primero");
        dataOverlay.style.display = "flex";
        return;
      }
      const total = cart.reduce((sum, item) => sum + item.price, 0);
      const order = { items: cart, total, type: "cesta" };
      showBizumModal(order);
    });

    // Enviar correos
    function sendConfirmationEmails(order, data) {
      const itemsList = order.items.map(item => 
        `${item.quantity}x ${item.product} (${item.materials.join(", ")}) - ‚Ç¨${item.price}`
      ).join("<br>");

      const customerEmail = {
        to_email: auth.currentUser.email,
        from_name: "Enlluernand",
        subject: "‚úÖ Tu pedido est√° confirmado",
        message: `
          <h2>¬°Hola ${data.name}!</h2>
          <p>Gracias por tu compra en Enlluernand üíõ</p>
          <h3>Detalles de tu pedido:</h3>
          <div>${itemsList}</div>
          <p><strong>Total: ‚Ç¨${order.total}</strong></p>
          <h3>Datos de env√≠o:</h3>
          <p>${data.name}<br>${data.address}<br>${data.postal} ${data.city}<br>${data.province}, ${data.country}<br>Tel: ${data.phone}</p>
          <p>Pago por Bizum al <strong>676 99 6</strong>.</p>
          <br>
          <p>Un abrazo,<br>Enlluernand</p>
        `
      };

      const ownerEmail = {
        to_email: "tuemail@enlluernand.com", // ‚Üê CAMBIA POR TU EMAIL
        from_name: "Enlluernand",
        subject: "üì¶ Nuevo pedido recibido",
        message: `
          <h2>üîî Nuevo pedido de ${data.name}</h2>
          <p><strong>Email:</strong> ${auth.currentUser.email}</p>
          <p><strong>Nombre:</strong> ${data.name}</p>
          <p><strong>Tel√©fono:</strong> ${data.phone}</p>
          <p><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>
          <h3>Productos:</h3>
          <div>${itemsList}</div>
          <p><strong>Total: ‚Ç¨${order.total}</strong></p>
          <h3>üöö Env√≠o a:</h3>
          <p>${data.address}<br>${data.postal} ${data.city}<br>${data.province}, ${data.country}</p>
          <p>Pago por Bizum al 676 99 6</p>
        `
      };

      emailjs.send("service_gmail", "template_pedido", customerEmail)
        .then(() => console.log("‚úÖ Email al cliente enviado"))
        .catch(err => console.error("‚ùå Error al enviar email al cliente:", err));

      emailjs.send("service_gmail", "template_pedido", ownerEmail)
        .then(() => console.log("‚úÖ Email a propietaria enviado"))
        .catch(err => console.error("‚ùå Error al enviar email a propietaria:", err));
    }

    document.getElementById("closeCart").addEventListener("click", () => {
      document.getElementById("cartSidebar").classList.remove("open");
    });

    // Inicializar
    window.onload = function() {
      llenarConectores();
      renderSummary();
    };
  </script>
</body>
</html>
