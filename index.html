<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enlluernand â€” Configurador & CatÃ¡logo</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- LibrerÃ­as para PDF (opcional) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #e6f3ff; }
    header {
      background: #0077cc;
      color: white;
      padding: 15px 20px;
      position: relative;
      text-align: left;
    }
    header h1 { margin: 0; font-size: 28px; text-align: center; }
    header p { margin: 5px 0 0; font-size: 16px; text-align: center; }

    .header-buttons {
      display: flex;
      gap: 15px;
      position: absolute;
      top: 15px;
      right: 20px;
    }

    .auth-btn, .cart-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .auth-btn { background: white; color: #0077cc; border: none; }
    .auth-btn:hover { background: #eef; }
    .cart-btn { background: #0077cc; color: white; border: none; }
    .cart-btn:hover { background: #005fa3; }

    .main-container { display: flex; gap: 20px; max-width: 1400px; margin: 20px auto; padding: 0 20px; }
    section { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px; }
    #configurador { flex: 2; }
    #catalogo { flex: 1; }

    h2 { border-bottom: 2px solid #0077cc; padding-bottom: 5px; }
    label { display: block; margin: 8px 0 4px; font-weight: bold; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 6px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #0077cc; color: #fff; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin: 5px 5px 0 0; }
    button:hover { background: #005fa3; }
    .summary { background: #eef7ff; padding: 10px; border-radius: 6px; margin-top: 10px; }

    .item-list {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .item-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }

    .item-row button {
      background: #ff6666; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer;
    }

    .color-options { display: flex; gap: 10px; margin: 8px 0 12px; }
    .color-ball { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #333; cursor: pointer; }

    .config-container { display: flex; gap: 20px; }
    .preview { flex: 1; background: #f9f9f9; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-direction: column; font-size: 16px; min-height: 300px; padding: 15px; text-align: center; }

    .preview-title { font-size: 1.4em; font-weight: bold; color: #0077cc; margin: 0 0 10px; }
    .preview-line { font-size: 0.95em; color: #555; margin: 3px 0; }
    .preview-colors { display: flex; gap: 6px; margin: 8px 0; justify-content: center; }

    .sidebar { position: fixed; top: 0; right: -400px; width: 350px; height: 100%; background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.2); transition: right 0.3s ease; padding: 20px; display: flex; flex-direction: column; z-index: 1000; }
    .sidebar.open { right: 0; }
    .sidebar h2 { margin-top: 0; }
    .cesta-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .close-btn { background: #ccc; color: black; align-self: flex-end; margin-bottom: 10px; }
  </style>
</head>
<body>

  <header>
    <h1>Enlluernand</h1>
    <p>Crea tu accesorio o descubre nuestras creaciones</p>
    <div class="header-buttons">
      <button class="auth-btn" id="authButton">Iniciar sesiÃ³n</button>
      <button class="cart-btn" id="openCart">ðŸ›’ Cesta (0)</button>
    </div>
  </header>

  <!-- Modal de Bienvenida -->
  <div id="welcomeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:12px; max-width:400px; text-align:center;">
      <h2 id="welcomeTitle">ðŸŽ‰ Â¡Hola!</h2>
      <p id="welcomeMessage">Tu cÃ³digo de descuento es:</p>
      <div id="discountCode" style="font-size:1.5em; font-weight:bold; color:#0077cc; margin:10px 0;"></div>
      <button onclick="copyCode()" style="background:#0077cc; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Copiar cÃ³digo</button>
      <button onclick="useCode()" style="margin-top:10px; background:#0077cc; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Usar cÃ³digo</button>
      <button onclick="closeModal()" style="margin-top:10px; background:#ccc; color:black; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Cerrar</button>
    </div>
  </div>

  <div class="main-container">
    <!-- Configurador -->
    <section id="configurador">
      <h2>Configurador de accesorios</h2>
      <div class="config-container">
        <!-- Vista previa -->
        <div class="preview" id="preview">
          <div class="preview-title">NingÃºn producto</div>
          <div class="preview-line">Selecciona collar, pulsera o pendientes</div>
        </div>

        <!-- Controles -->
        <div class="controls">
          <!-- Producto (Ãºnico) -->
          <label>Producto</label>
          <select id="product">
            <option value="">Selecciona un producto...</option>
            <option value="collar">Collar</option>
            <option value="pulsera">Pulsera</option>
            <option value="pendientes">Pendientes</option>
          </select>

          <!-- MÃºltiples materiales -->
          <div>
            <label>Material</label>
            <select id="add-material-select">
              <option value="">Seleccionar material...</option>
              <option value="oro">Cadena de oro</option>
              <option value="plata">Cadena de plata</option>
              <option value="cordon">CordÃ³n de colores</option>
            </select>
            <button type="button" id="add-material-btn">+ AÃ±adir material</button>
            <div class="item-list" id="materials-list">
              <div class="item-row" id="material-template" style="display:none;">
                <span class="name"></span>
                <button class="remove">âœ–</button>
              </div>
            </div>
          </div>

          <!-- MÃºltiples colores -->
          <div>
            <label>Color</label>
            <div class="color-options" id="color-options-add">
              <div class="color-ball" style="background:red" data-color="rojo"></div>
              <div class="color-ball" style="background:blue" data-color="azul"></div>
              <div class="color-ball" style="background:green" data-color="verde"></div>
              <div class="color-ball" style="background:yellow" data-color="amarillo"></div>
              <div class="color-ball" style="background:pink" data-color="rosa"></div>
              <div class="color-ball" style="background:purple" data-color="morado"></div>
            </div>
            <div class="item-list" id="colors-list">
              <div class="item-row" id="color-template" style="display:none;">
                <span class="name"></span>
                <button class="remove">âœ–</button>
              </div>
            </div>
          </div>

          <!-- MÃºltiples colgantes -->
          <div>
            <label>Colgante</label>
            <select id="add-colgante-select">
              <option value="">Seleccionar colgante...</option>
              <option value="corazon">CorazÃ³n</option>
              <option value="estrella">Estrella</option>
              <option value="nube">Nube</option>
              <option value="flor">Flor</option>
            </select>
            <button type="button" id="add-colgante-btn">+ AÃ±adir colgante</button>
            <div class="item-list" id="colgantes-list">
              <div class="item-row" id="colgante-template" style="display:none;">
                <span class="name"></span>
                <button class="remove">âœ–</button>
              </div>
            </div>
          </div>

          <!-- Conectores mÃºltiples -->
          <div>
            <label>Conectores adicionales</label>
            <div class="item-list" id="conectores-list">
              <div class="item-row" id="conector-template" style="display:none;">
                <span class="name"></span>
                <input type="number" value="1" min="1" class="cantidad" style="width:50px;">
                <button class="remove">âœ–</button>
              </div>
            </div>
            <select id="add-conector-select">
              <option value="">Seleccionar conector...</option>
            </select>
            <button type="button" id="add-conector-btn">+ AÃ±adir conector</button>
          </div>

          <!-- Extras mÃºltiples -->
          <div>
            <label>Extras</label>
            <div class="item-list" id="extras-list">
              <div class="item-row" id="extra-template" style="display:none;">
                <span class="name"></span>
                <input type="number" value="1" min="1" class="cantidad" style="width:50px;">
                <button class="remove">âœ–</button>
              </div>
            </div>
            <select id="add-extra-select">
              <option value="">Seleccionar extra...</option>
              <option value="gift">Estuche para regalo (+5â‚¬)</option>
              <option value="wrap">Envoltorio para regalo (+3â‚¬)</option>
              <option value="urgent">FabricaciÃ³n urgente (+10â‚¬)</option>
            </select>
            <button type="button" id="add-extra-btn">+ AÃ±adir extra</button>
          </div>

          <label>CÃ³digo de descuento</label>
          <input type="text" id="discount" placeholder="Introduce tu cÃ³digo">

          <label>Cantidad</label>
          <input type="number" id="quantity" value="1" min="1">

          <div class="summary" id="summary">Precio: â‚¬0</div>

          <button id="addToCart">AÃ±adir a la cesta</button>
          <button id="payNow">Pagar ahora</button>
        </div>
      </div>
    </section>

    <!-- CatÃ¡logo -->
    <section id="catalogo">
      <h2>CatÃ¡logo</h2>
      <h3>Collares</h3>
      <img src="https://via.placeholder.com/200?text=Collar+1">
      <h3>Pendientes</h3>
      <img src="https://via.placeholder.com/200?text=Pendiente+1">
      <h3>Pulseras</h3>
      <img src="https://via.placeholder.com/200?text=Pulsera+1">
    </section>
  </div>

  <!-- Sidebar de la Cesta -->
  <div class="sidebar" id="cartSidebar">
    <button class="close-btn" id="closeCart">Cerrar âœ–</button>
    <h2>Tu Cesta</h2>
    <div id="cartItems"></div>
    <div class="summary" id="cartSummary">Total: â‚¬0</div>
    <button id="pay">Pagar</button>
  </div>

  <script>
    // Inicializar EmailJS
    (function(){ emailjs.init("QySTAkWHd-G0OkzSS"); })();

    // ConfiguraciÃ³n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCZbhHY9mEr3bBMVZLGxZE4NkGMLSPTcL4",
      authDomain: "enlluernand-77eb5.firebaseapp.com",
      projectId: "enlluernand-77eb5",
      storageBucket: "enlluernand-77eb5.firebasestorage.app",
      messagingSenderId: "904366283683",
      appId: "1:904366283683:web:816bf521d4b858a4a25816"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Datos de tu Excel (solo conectores)
    const materiales = [
      {"Codigo": 13,"Descripcion": "Conector Collar ORO","Unidades": 20,"Precio": "2,9200","Costo": "0,1460","Unidades Restantes": 20},
      {"Codigo": 14,"Descripcion": "Conector Collar PLATA","Unidades": 20,"Precio": "2,6000","Costo": "0,1300","Unidades Restantes": 20},
      {"Codigo": 15,"Descripcion": "Conector Resina ORO","Unidades": 40,"Precio": "1,3900","Costo": "0,0348","Unidades Restantes": 40},
      {"Codigo": 16,"Descripcion": "Conector Resina PLATA","Unidades": 40,"Precio": "1,3900","Costo": "0,0348","Unidades Restantes": 40},
      {"Codigo": 17,"Descripcion": "Conector Resina Trebol ORO","Unidades": 20,"Precio": "1,9300","Costo": "0,0965","Unidades Restantes": 20},
      {"Codigo": 18,"Descripcion": "Conector final","Unidades": 235,"Precio": "1,3000","Costo": "0,0055","Unidades Restantes": 235},
      {"Codigo": 114,"Descripcion": "Conector Doble Oro *15cm","Unidades": 20,"Precio": "2,0300","Costo": "0,1015","Unidades Restantes": 20},
      {"Codigo": 115,"Descripcion": "Conector Doble Plata *15cm","Unidades": 20,"Precio": "2,0300","Costo": "0,1015","Unidades Restantes": 20},
      {"Codigo": 116,"Descripcion": "Conector Triple Cadena Oro *20cm/30cm","Unidades": 2,"Precio": "1,0150","Costo": "0,5075","Unidades Restantes": 2},
      {"Codigo": 117,"Descripcion": "Conector Triple Cadena Plata *20cm/30cm","Unidades": 2,"Precio": "1,0150","Costo": "0,5075","Unidades Restantes": 2},
      {"Codigo": 118,"Descripcion": "Anilla Cuerda Oro *6mm","Unidades": 10,"Precio": "0,6389","Costo": "0,0639","Unidades Restantes": 10},
      {"Codigo": 119,"Descripcion": "Anilla Cuerda Plata *6mm","Unidades": 10,"Precio": "0,6389","Costo": "0,0639","Unidades Restantes": 10},
      {"Codigo": 120,"Descripcion": "Conector Doble Brillante Oro","Unidades": 10,"Precio": "0,7667","Costo": "0,0767","Unidades Restantes": 10},
      {"Codigo": 121,"Descripcion": "Conector Doble Brillante Plata","Unidades": 10,"Precio": "0,7667","Costo": "0,0767","Unidades Restantes": 10},
      {"Codigo": 124,"Descripcion": "Conectar Cuadruple Oro","Unidades": 2,"Precio": "0,5111","Costo": "0,2556","Unidades Restantes": 2},
      {"Codigo": 125,"Descripcion": "Conector Cuadruple Plata","Unidades": 2,"Precio": "0,5111","Costo": "0,2556","Unidades Restantes": 2},
      {"Codigo": 126,"Descripcion": "Conector Quintuple Plata","Unidades": 4,"Precio": "0,6389","Costo": "0,1597","Unidades Restantes": 4}
    ];

    // Extras disponibles
    const extras = {
      gift: { name: "Estuche para regalo", price: 5 },
      wrap: { name: "Envoltorio para regalo", price: 3 },
      urgent: { name: "FabricaciÃ³n urgente", price: 10 }
    };

    // Variables
    let cart = [];
    let selectedColors = []; // MÃºltiples colores
    let userDiscountCode = null;
    let userDisplayName = null;

    // Elementos del DOM
    const summary = document.getElementById("summary");
    const cartItems = document.getElementById("cartItems");
    const cartSummary = document.getElementById("cartSummary");
    const cartBtn = document.getElementById("openCart");
    const preview = document.getElementById("preview");
    const authButton = document.getElementById("authButton");
    const discountInput = document.getElementById("discount");

    // Generar cÃ³digo de descuento Ãºnico
    function generarCodigoDescuento() {
      const prefijos = ["BIENVENIDA", "LUZ", "AMOR", "ESTRELLA"];
      const prefijo = prefijos[Math.floor(Math.random() * prefijos.length)];
      const numero = Math.floor(Math.random() * 20 + 5);
      return prefijo + numero + Math.random().toString(36).substr(2, 4).toUpperCase();
    }

    // Mostrar modal de bienvenida
    function mostrarBienvenida(nombre) {
      const codeElem = document.getElementById("discountCode");
      codeElem.textContent = userDiscountCode;

      const titleElem = document.getElementById("welcomeTitle");
      titleElem.textContent = `ðŸŽ‰ Â¡Hola, ${nombre}!`;

      const messageElem = document.getElementById("welcomeMessage");
      messageElem.textContent = `Tu cÃ³digo de descuento es:`;

      document.getElementById("welcomeModal").style.display = "block";
    }

    // Funciones del modal
    function closeModal() {
      document.getElementById("welcomeModal").style.display = "none";
    }

    function copyCode() {
      const code = document.getElementById("discountCode").textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert("âœ… CÃ³digo copiado al portapapeles!");
      });
    }

    function useCode() {
      const code = document.getElementById("discountCode").textContent;
      discountInput.value = code;
      alert(`âœ… CÃ³digo "${code}" aplicado al campo.`);
      closeModal();
    }

    // Escuchar cambios de autenticaciÃ³n
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userRef = db.collection("usuarios").doc(user.uid);
        const doc = await userRef.get();

        if (!doc.exists) {
          userDiscountCode = generarCodigoDescuento();
          userDisplayName = user.displayName || user.email.split("@")[0];

          await userRef.set({
            email: user.email,
            nombre: userDisplayName,
            fechaRegistro: new Date(),
            codigoDescuento: userDiscountCode,
            usado: false,
            expira: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24h despuÃ©s
          });

          mostrarBienvenida(userDisplayName);
        } else {
          const data = doc.data();
          userDiscountCode = data.codigoDescuento;
          userDisplayName = data.nombre;

          if (new Date() > new Date(data.expira)) {
            userDiscountCode = null;
          }
          if (data.usado) {
            userDiscountCode = null;
          }
        }
        authButton.textContent = "Cerrar sesiÃ³n";
      } else {
        userDiscountCode = null;
        userDisplayName = null;
        authButton.textContent = "Iniciar sesiÃ³n";
      }
      renderSummary();
    });

    // Manejar clic en botÃ³n de autenticaciÃ³n
    authButton.addEventListener("click", () => {
      const user = auth.currentUser;
      if (user) {
        auth.signOut().then(() => {
          alert("SesiÃ³n cerrada correctamente.");
        });
      } else {
        const opcion = confirm("Â¿Quieres iniciar sesiÃ³n con Google?\nAceptar = Google, Cancelar = Correo y contraseÃ±a");
        if (opcion) {
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider).catch(error => {
            alert("Error al iniciar con Google: " + error.message);
          });
        } else {
          const email = prompt("ðŸ“§ Introduce tu correo electrÃ³nico:");
          if (!email) return;
          const password = prompt("ðŸ”‘ Introduce tu contraseÃ±a (mÃ­nimo 6 caracteres):");
          if (!password || password.length < 6) {
            alert("La contraseÃ±a debe tener al menos 6 caracteres.");
            return;
          }

          auth.fetchSignInMethodsForEmail(email)
            .then(methods => {
              if (methods.length === 0) {
                return auth.createUserWithEmailAndPassword(email, password);
              } else {
                return auth.signInWithEmailAndPassword(email, password);
              }
            })
            .catch(error => {
              alert("Error: " + error.message);
            });
        }
      }
    });

    // Llenar selectores
    function llenarConectores() {
      const select = document.getElementById("add-conector-select");
      select.innerHTML = '<option value="">Seleccionar conector...</option>';
      materiales.forEach(item => {
        const option = document.createElement("option");
        option.value = item.Codigo;
        option.textContent = `${item.Descripcion} - â‚¬${item.Precio}`;
        select.appendChild(option);
      });
    }

    // AÃ±adir material
    document.getElementById("add-material-btn").addEventListener("click", () => {
      const select = document.getElementById("add-material-select");
      const value = select.value;
      if (!value) return;
      const name = select.options[select.selectedIndex].text;

      const list = document.getElementById("materials-list");
      const row = document.createElement("div");
      row.className = "item-row";
      row.dataset.value = value;
      row.innerHTML = `<span class="name">${name}</span><button class="remove">âœ–</button>`;
      list.appendChild(row);
      select.value = "";
      renderSummary();
    });

    // AÃ±adir colgante
    document.getElementById("add-colgante-btn").addEventListener("click", () => {
      const select = document.getElementById("add-colgante-select");
      const value = select.value;
      if (!value) return;
      const name = select.options[select.selectedIndex].text;

      const list = document.getElementById("colgantes-list");
      const row = document.createElement("div");
      row.className = "item-row";
      row.dataset.value = value;
      row.innerHTML = `<span class="name">${name}</span><button class="remove">âœ–</button>`;
      list.appendChild(row);
      select.value = "";
      renderSummary();
    });

    // Seleccionar color
    document.getElementById("color-options-add").addEventListener("click", (e) => {
      if (e.target.classList.contains("color-ball")) {
        const color = e.target.dataset.color;
        if (!selectedColors.includes(color)) {
          selectedColors.push(color);

          const list = document.getElementById("colors-list");
          const row = document.createElement("div");
          row.className = "item-row";
          row.dataset.color = color;
          row.innerHTML = `<span class="name">Color: ${color}</span><button class="remove">âœ–</button>`;
          list.appendChild(row);
          renderSummary();
        }
      }
    });

    // Eliminar elementos
    document.getElementById("materials-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) e.target.closest(".item-row").remove(); renderSummary();
    });
    document.getElementById("colors-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) {
        const color = e.target.closest(".item-row").dataset.color;
        selectedColors = selectedColors.filter(c => c !== color);
        e.target.closest(".item-row").remove();
        renderSummary();
      }
    });
    document.getElementById("colgantes-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) e.target.closest(".item-row").remove(); renderSummary();
    });
    document.getElementById("conectores-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) e.target.closest(".item-row").remove(); renderSummary();
    });
    document.getElementById("extras-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("remove")) e.target.closest(".item-row").remove(); renderSummary();
    });

    // Obtener elementos seleccionados
    function getSelectedMaterials() {
      return Array.from(document.querySelectorAll("#materials-list .item-row")).map(r => r.dataset.value);
    }
    function getSelectedColgantes() {
      return Array.from(document.querySelectorAll("#colgantes-list .item-row")).map(r => r.dataset.value);
    }
    function getSelectedConectores() {
      return Array.from(document.querySelectorAll("#conectores-list .item-row")).map(row => {
        const codigo = row.dataset.codigo;
        const material = materiales.find(m => m.Codigo == codigo);
        return material ? material.Descripcion : "Desconocido";
      });
    }
    function getSelectedExtras() {
      return Array.from(document.querySelectorAll("#extras-list .item-row")).map(row => {
        const key = row.dataset.key;
        return extras[key]?.name || "Extra";
      });
    }

    // CÃ¡lculo de precio
    function calculatePrice(config) {
      let price = 20;
      const materials = getSelectedMaterials();
      price += materials.filter(m => m === "oro").length * 30;
      price += materials.filter(m => m === "plata").length * 15;
      price += materials.filter(m => m === "cordon").length * 10;

      // Conectores
      const conectores = Array.from(document.querySelectorAll("#conectores-list .item-row")).map(row => {
        const codigo = row.dataset.codigo;
        const cantidad = parseInt(row.querySelector(".cantidad").value) || 1;
        return { codigo, cantidad };
      });
      conectores.forEach(item => {
        const material = materiales.find(m => m.Codigo == item.codigo);
        if (material) {
          const precioNum = parseFloat(material.Precio.replace(",", "."));
          price += precioNum * item.cantidad;
        }
      });

      // Extras
      const extrasList = Array.from(document.querySelectorAll("#extras-list .item-row")).map(row => {
        const key = row.dataset.key;
        const cantidad = parseInt(row.querySelector(".cantidad").value) || 1;
        return { key, cantidad };
      });
      extrasList.forEach(item => {
        const extra = extras[item.key];
        if (extra) {
          price += extra.price * item.cantidad;
        }
      });

      price *= config.quantity;

      // Descuento
      if (config.discount && config.discount === "DESCUENTO10") {
        price *= 0.95;
      } else if (config.discount && config.discount === userDiscountCode) {
        const user = auth.currentUser;
        if (user) {
          db.collection("usuarios").doc(user.uid).get().then(doc => {
            const data = doc.data();
            if (data.usado) {
              alert("âŒ Este cÃ³digo ya fue usado.");
              return;
            }
            if (new Date() > new Date(data.expira)) {
              alert("âŒ Este cÃ³digo ha expirado.");
              return;
            }
            db.collection("usuarios").doc(user.uid).update({ usado: true });
            alert("âœ… Â¡CÃ³digo de bienvenida aplicado! 5% de descuento.");
          });
        }
        price *= 0.95;
      }

      return Math.round(price * 100) / 100;
    }

    function getConfig() {
      return {
        product: document.getElementById("product").value,
        materials: getSelectedMaterials(),
        colors: selectedColors,
        colgantes: getSelectedColgantes(),
        conectores: Array.from(document.querySelectorAll("#conectores-list .item-row")).map(row => ({
          codigo: row.dataset.codigo,
          cantidad: parseInt(row.querySelector(".cantidad").value) || 1
        })),
        extras: Array.from(document.querySelectorAll("#extras-list .item-row")).map(row => ({
          key: row.dataset.key,
          cantidad: parseInt(row.querySelector(".cantidad").value) || 1
        })),
        discount: document.getElementById("discount").value,
        quantity: parseInt(document.getElementById("quantity").value) || 1
      };
    }

    function renderSummary() {
      const config = getConfig();
      const price = calculatePrice(config);
      summary.textContent = `Precio: â‚¬${price}`;

      const product = config.product;
      const materials = getSelectedMaterials();
      const colgantes = getSelectedColgantes();
      const conectores = getSelectedConectores();
      const extrasList = getSelectedExtras();

      if (!product) {
        preview.innerHTML = `
          <div class="preview-title">NingÃºn producto</div>
          <div class="preview-line">Selecciona collar, pulsera o pendientes</div>
        `;
        return;
      }

      let html = `<div class="preview-title">${product.charAt(0).toUpperCase() + product.slice(1)}</div>`;
      if (materials.length > 0) html += `<div class="preview-line">Materiales: ${materials.join(", ")}</div>`;
      if (config.colors.length > 0) {
        html += `<div class="preview-line">Colores:</div><div class="preview-colors">`;
        config.colors.forEach(color => {
          html += `<div class="color-ball" style="background:${color}; width:18px; height:18px;"></div>`;
        });
        html += `</div>`;
      }
      if (colgantes.length > 0) html += `<div class="preview-line">Colgantes: ${colgantes.join(", ")}</div>`;
      if (conectores.length > 0) html += `<div class="preview-line">Conectores: ${conectores.length}</div>`;
      if (extrasList.length > 0) html += `<div class="preview-line">Extras: ${extrasList.join(", ")}</div>`;

      preview.innerHTML = html;
    }

    function renderCart() {
      cartItems.innerHTML = "";
      let total = 0;
      cart.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "cesta-item";
        div.innerHTML = `
          <strong>${item.quantity}x ${item.product}</strong><br>
          Materiales: ${item.materials.join(", ")}<br>
          Colores: ${item.colors.join(", ")}<br>
          Colgantes: ${item.colgantes.join(", ")}<br>
          Precio: â‚¬${item.price}
          <hr>
        `;
        cartItems.appendChild(div);
        total += item.price;
      });
      cartSummary.textContent = `Total: â‚¬${total}`;
      cartBtn.textContent = `ðŸ›’ Cesta (${cart.length})`;
    }

    // AÃ±adir a la cesta
    document.getElementById("addToCart").addEventListener("click", () => {
      const config = getConfig();
      const product = config.product;
      if (!product) {
        alert("âš ï¸ Por favor, selecciona un producto (collar, pulsera o pendientes)");
        return;
      }
      const price = calculatePrice(config);
      cart.push({ ...config, price });
      renderCart();
      alert("âœ… ArtÃ­culo aÃ±adido a la cesta");
    });

    // Pagar
    document.getElementById("pay").addEventListener("click", () => {
      if (cart.length === 0) {
        alert("Tu cesta estÃ¡ vacÃ­a");
        return;
      }
      alert("âœ… Pago procesado. Gracias por tu compra.");
      cart = [];
      renderCart();
      document.getElementById("cartSidebar").classList.remove("open");
    });

    document.getElementById("payNow").addEventListener("click", () => {
      const config = getConfig();
      if (!config.product) {
        alert("âš ï¸ Selecciona un producto antes de pagar");
        return;
      }
      config.price = calculatePrice(config);
      alert(`âœ… Pago inmediato procesado - Total: â‚¬${config.price}`);
    });

    document.getElementById("product").addEventListener("change", renderSummary);
    document.getElementById("quantity").addEventListener("input", renderSummary);
    document.getElementById("discount").addEventListener("input", renderSummary);

    document.getElementById("openCart").addEventListener("click", () => {
      document.getElementById("cartSidebar").classList.add("open");
    });

    document.getElementById("closeCart").addEventListener("click", () => {
      document.getElementById("cartSidebar").classList.remove("open");
    });

    // Inicializar
    window.onload = function() {
      llenarConectores();
      renderSummary();
    };
  </script>
</body>
</html>
