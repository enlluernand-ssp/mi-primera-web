<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enlluernand — Configurador & Catálogo</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #e6f3ff; }
    header { background: #0077cc; color: white; padding: 15px 20px; position: relative; text-align: center; }
    header h1 { margin: 0; font-size: 28px; }
    header p { margin: 5px 0 0; font-size: 16px; }
    .cart-btn { position: absolute; top: 15px; right: 20px; background: white; color: #0077cc; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .cart-btn:hover { background: #eef; }

    .main-container { display: flex; gap: 20px; max-width: 1400px; margin: 20px auto; padding: 0 20px; }
    section { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px; }
    #configurador { flex: 2; }
    #catalogo { flex: 1; }

    h2 { border-bottom: 2px solid #0077cc; padding-bottom: 5px; }
    label { display: block; margin: 8px 0 4px; font-weight: bold; }
    select, input[type="number"], input[type="text"] { width: 100%; padding: 6px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #0077cc; color: #fff; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin: 5px 5px 0 0; }
    button:hover { background: #005fa3; }
    .summary { background: #eef7ff; padding: 10px; border-radius: 6px; margin-top: 10px; }

    .color-options { display: flex; gap: 10px; margin: 8px 0 12px; }
    .color-ball { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #333; cursor: pointer; }
    .config-container { display: flex; gap: 20px; }
    .preview { flex: 1; background: #f9f9f9; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-direction: column; font-size: 18px; min-height: 300px; }
    .controls { flex: 1; }

    .sidebar { position: fixed; top: 0; right: -400px; width: 350px; height: 100%; background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.2); transition: right 0.3s ease; padding: 20px; display: flex; flex-direction: column; z-index: 1000; }
    .sidebar.open { right: 0; }
    .sidebar h2 { margin-top: 0; }
    .cesta-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .close-btn { background: #ccc; color: black; align-self: flex-end; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Enlluernand</h1>
    <p>Crea tu accesorio o descubre nuestras creaciones</p>
    <button class="cart-btn" id="openCart">🛒 Cesta (0)</button>
  </header>

  <div class="main-container">
    <!-- Configurador -->
    <section id="configurador">
      <h2>Configurador de accesorios</h2>
      <div class="config-container">
        <div class="preview" id="preview"><strong>collar</strong><br>Material: oro</div>
        <div class="controls">
          <label>Producto</label>
          <select id="product">
            <option value="collar">Collar</option>
            <option value="pulsera">Pulsera</option>
            <option value="pendientes">Pendientes</option>
          </select>

          <label>Material</label>
          <select id="material">
            <option value="oro">Cadena de oro</option>
            <option value="plata">Cadena de plata</option>
            <option value="cordon">Cordón de colores</option>
          </select>

          <label>Colores disponibles</label>
          <div class="color-options" id="colorOptions">
            <div class="color-ball" style="background:red" data-color="rojo"></div>
            <div class="color-ball" style="background:blue" data-color="azul"></div>
            <div class="color-ball" style="background:green" data-color="verde"></div>
            <div class="color-ball" style="background:yellow" data-color="amarillo"></div>
            <div class="color-ball" style="background:pink" data-color="rosa"></div>
            <div class="color-ball" style="background:purple" data-color="morado"></div>
          </div>

          <label>Colgante</label>
          <select id="colgante"><option value="">Ninguno</option><option value="corazon">Corazón</option></select>
          <label>Conector</label>
          <select id="conector"><option value="">Ninguno</option><option value="anilla">Anilla</option></select>

          <label>Extras</label>
          <input type="checkbox" id="extraGift"> Estuche para regalo (+5€)<br>
          <input type="checkbox" id="extraWrap"> Envoltorio para regalo (+3€)<br>
          <input type="checkbox" id="extraUrgent"> Fabricación urgente (+10€)

          <label>Código de descuento</label>
          <input type="text" id="discount" placeholder="Introduce tu código">

          <label>Cantidad</label>
          <input type="number" id="quantity" value="1" min="1">

          <div class="summary" id="summary">Precio: €0</div>

          <button id="addToCart">Añadir a la cesta</button>
          <button id="payNow">Pagar ahora</button>
        </div>
      </div>
    </section>

    <!-- Catálogo -->
    <section id="catalogo">
      <h2>Catálogo</h2>
      <h3>Collares</h3>
      <img src="https://via.placeholder.com/200?text=Collar+1">
      <h3>Pendientes</h3>
      <img src="https://via.placeholder.com/200?text=Pendiente+1">
      <h3>Pulseras</h3>
      <img src="https://via.placeholder.com/200?text=Pulsera+1">
    </section>
  </div>

  <!-- Sidebar de la Cesta -->
  <div class="sidebar" id="cartSidebar">
    <button class="close-btn" id="closeCart">Cerrar ✖</button>
    <h2>Tu Cesta</h2>
    <div id="cartItems"></div>
    <div class="summary" id="cartSummary">Total: €0</div>
    <button id="pay">Pagar</button>
  </div>

  <script>
    (function(){ emailjs.init("QySTAkWHd-G0OkzSS"); })();

    let cart = [];
    let selectedColor = "";
    const summary = document.getElementById("summary");
    const cartItems = document.getElementById("cartItems");
    const cartSummary = document.getElementById("cartSummary");
    const cartBtn = document.getElementById("openCart");
    const preview = document.getElementById("preview");

    function calculatePrice(config) {
      let price = 20;
      if(config.material==="oro") price += 30;
      if(config.material==="plata") price += 15;
      if(config.extras.includes("gift")) price += 5;
      if(config.extras.includes("wrap")) price += 3;
      if(config.extras.includes("urgent")) price += 10;
      price *= config.quantity;
      if(config.discount==="DESCUENTO10") price *= 0.9;
      return price;
    }
    function getConfig() {
      return {
        product: document.getElementById("product").value,
        material: document.getElementById("material").value,
        color: selectedColor,
        colgante: document.getElementById("colgante").value,
        conector: document.getElementById("conector").value,
        extras: [
          ...document.getElementById("extraGift").checked ? ["gift"] : [],
          ...document.getElementById("extraWrap").checked ? ["wrap"] : [],
          ...document.getElementById("extraUrgent").checked ? ["urgent"] : []
        ],
        discount: document.getElementById("discount").value,
        quantity: parseInt(document.getElementById("quantity").value) || 1
      };
    }
    function renderSummary() {
      const config = getConfig();
      const price = calculatePrice(config);
      summary.textContent = `Precio: €${price}`;
      preview.innerHTML = `<strong>${config.product}</strong><br>Material: ${config.material}`;
    }
    function renderCart() {
      cartItems.innerHTML = "";
      let total = 0;
      cart.forEach((item)=>{
        const div = document.createElement("div");
        div.className = "cesta-item";
        div.textContent = `${item.quantity}x ${item.product} (${item.material}, ${item.color}) - €${item.price}`;
        cartItems.appendChild(div);
        total += item.price;
      });
      cartSummary.textContent = `Total: €${total}`;
      cartBtn.textContent = `🛒 Cesta (${cart.length})`;
    }

    async function sendEmail(order) {
      try {
        // Capturar imagen del preview
        const canvas = await html2canvas(document.getElementById("preview"));
        const imgData = canvas.toDataURL("image/png");

        // Generar factura PDF (base64 como URL para botón)
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("Factura - Enlluernand", 10, 20);
        doc.setFontSize(12);
        doc.text(`Producto: ${order.product}`, 10, 40);
        doc.text(`Material: ${order.material}`, 10, 50);
        doc.text(`Color: ${order.color}`, 10, 60);
        doc.text(`Colgante: ${order.colgante}`, 10, 70);
        doc.text(`Conector: ${order.conector}`, 10, 80);
        doc.text(`Extras: ${order.extras.join(", ")}`, 10, 90);
        doc.text(`Cantidad: ${order.quantity}`, 10, 100);
        doc.text(`Precio: €${order.price}`, 10, 110);
        const pdfBase64 = doc.output("datauristring");

        // Enviar correos en paralelo
        await Promise.all([
          // Cliente: datos + botón factura
          emailjs.send("service_tu3gqxw","template_z7kk7wq",{
            product: order.product,
            material: order.material,
            color: order.color,
            colgante: order.colgante,
            conector: order.conector,
            extras: order.extras.join(", "),
            discount: order.discount,
            quantity: order.quantity,
            price: order.price,
            preview_image: imgData,
            factura_url: pdfBase64
          }),
          // Interno: datos + imagen
          emailjs.send("service_tu3gqxw","template_0orquhm",{
            product: order.product,
            material: order.material,
            color: order.color,
            colgante: order.colgante,
            conector: order.conector,
            extras: order.extras.join(", "),
            discount: order.discount,
            quantity: order.quantity,
            price: order.price,
            preview_image: imgData
          })
        ]);

        alert("✅ Pedido enviado correctamente (cliente + interno)");
      } catch (err) {
        alert("❌ Error al enviar: " + JSON.stringify(err));
      }
    }

    document.getElementById("addToCart").addEventListener("click", ()=>{
      const config = getConfig();
      const price = calculatePrice(config);
      cart.push({...config, price});
      renderCart();
      alert("Producto añadido a la cesta");
    });
    document.getElementById("pay").addEventListener("click", ()=>{
      if(cart.length===0){ alert("Tu cesta está vacía"); return; }
      cart.forEach(order => sendEmail(order));
      cart = [];
      renderCart();
      document.getElementById("cartSidebar").classList.remove("open");
    });
    document.getElementById("payNow").addEventListener("click", ()=>{
      const config = getConfig();
      config.price = calculatePrice(config);
      sendEmail(config);
    });

    ["product","material","colgante","conector","discount","quantity","extraGift","extraWrap","extraUrgent"].forEach(id=>{
      document.getElementById(id).addEventListener("input", renderSummary);
      document.getElementById(id).addEventListener("change", renderSummary);
    });
    document.querySelectorAll(".color-ball").forEach(ball=>{
      ball.addEventListener("click", ()=>{
        selectedColor = ball.dataset.color;
        renderSummary();
      });
    });
    renderSummary();

    document.getElementById("openCart").addEventListener("click", ()=> document.getElementById("cartSidebar").classList.add("open"));
    document.getElementById("closeCart").addEventListener("click", ()=> document.getElementById("cartSidebar").classList.remove("open"));
  </script>
</body>
</html>
